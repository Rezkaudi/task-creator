<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Design Tool Pro</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      height: 100vh;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 24px;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s;
      margin-bottom: -2px;
    }

    .tab:hover {
      color: #6366f1;
    }

    .tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* AI Chat Styles */
    #ai-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 300px;
      max-height: calc(100vh - 280px);
    }

    .message {
      display: flex;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
    }

    .message-content {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: white;
      color: #374151;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-bottom-left-radius: 4px;
    }

    /* Design Preview */
    .design-preview {
      margin-top: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .design-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .design-preview-title {
      font-size: 12px;
      font-weight: 600;
      color: #6366f1;
    }

    .preview-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .expand-btn, .import-to-figma-btn {
      padding: 6px 12px;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .expand-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .import-to-figma-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .expand-btn:hover, .import-to-figma-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .design-preview-visual {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      margin-top: 8px;
      min-height: 180px;
      max-height: 350px;
      overflow: auto;
      position: relative;
    }

    .loading-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #chat-input-container {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    #chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: border-color 0.3s;
    }

    #chat-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    #chat-send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      height: 44px;
    }

    #chat-send-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .chat-hint {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      margin-top: 6px;
    }

    /* Other tabs styles */
    .input-group {
      margin-bottom: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    input[type="url"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="url"]:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    textarea {
      width: 100%;
      flex: 1;
      min-height: 150px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      resize: none;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    textarea.error {
      border-color: #ef4444;
    }

    textarea.valid {
      border-color: #22c55e;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
      word-break: break-word;
    }

    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
      display: block;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      display: block;
    }

    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
      display: block;
    }

    .status.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      display: block;
    }

    .helper-text {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .json-stats {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    .json-stats.error {
      color: #ef4444;
    }

    .export-options {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .export-options button {
      flex: 1;
    }

    .export-output {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .export-output textarea {
      flex: 1;
      min-height: 200px;
    }

    .copy-btn-wrapper {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .copy-btn-wrapper button {
      flex: none;
      padding: 8px 16px;
    }

    .selection-info {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #374151;
    }

    .selection-info strong {
      color: #6366f1;
    }

    .export-stats {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Design Tool Pro</h1>
    <p class="subtitle">Import, Export, or Generate designs with AI</p>
    <div id="status" class="status"></div>

    <div class="tabs">
      <button class="tab active" data-tab="ai">ü§ñ AI Generate</button>
      <button class="tab" data-tab="auto">üîó Fetch API</button>
      <button class="tab" data-tab="manual">üìã Paste JSON</button>
      <button class="tab" data-tab="export">üì§ Export</button>
    </div>

    <!-- AI Chat Tab -->
    <div id="ai-tab" class="tab-content active">
      <div id="ai-chat-container">
        <div id="chat-messages">
          <div class="message assistant">
            <div class="message-content">
              <div>Hi! Describe your design and I'll create it for you. üé®</div>
            </div>
          </div>
        </div>
        <div id="chat-input-container">
          <textarea id="chat-input" placeholder="e.g. Create a login page with email and password fields..." rows="1"></textarea>
          <button id="chat-send-btn">Send</button>
        </div>
        <div class="chat-hint">Press Enter to send ‚Ä¢ Shift + Enter for new line</div>
      </div>
    </div>

    <!-- Fetch API Tab -->
    <div id="auto-tab" class="tab-content">
      <div class="input-group">
        <label for="api-url">API Endpoint URL</label>
        <input type="url" id="api-url" value="http://localhost:5000/api/tasks/latest-design"
          placeholder="https://api.example.com/design" />
        <p class="helper-text">Enter the URL that returns Figma-compatible JSON.</p>
      </div>
      <div class="button-group">
        <button id="fetch-import-btn" class="btn-primary">üì• Fetch & Import</button>
        <button id="cancel-btn" class="btn-secondary">Cancel</button>
      </div>
    </div>

    <!-- Manual JSON Tab -->
    <div id="manual-tab" class="tab-content">
      <div class="input-group">
        <label for="json-input">Design JSON</label>
        <textarea id="json-input" placeholder='Paste your Figma design JSON here...

Example format:
{
  "name": "My Frame",
  "type": "FRAME",
  "x": 0,
  "y": 0,
  "width": 400,
  "height": 300,
  "fills": [{"type": "SOLID", "color": {"r": 1, "g": 1, "b": 1}}]
}'></textarea>
        <div id="json-stats" class="json-stats"></div>
      </div>
      <div class="button-group">
        <button id="json-import-btn" class="btn-primary">üìã Import JSON</button>
        <button id="json-cancel-btn" class="btn-secondary">Cancel</button>
      </div>
    </div>

    <!-- Export Tab -->
    <div id="export-tab" class="tab-content">
      <div id="selection-info" class="selection-info">
        <strong>No selection.</strong> Select layers to export specific elements, or export the entire page.
      </div>
      <div class="export-options">
        <button id="export-selected-btn" class="btn-primary" disabled>üì¶ Export Selected</button>
        <button id="export-all-btn" class="btn-success">üìÑ Export All (Page)</button>
      </div>
      <div class="export-output">
        <label for="export-output">Exported JSON</label>
        <textarea id="export-output" readonly
          placeholder="Click 'Export Selected' or 'Export All' to generate JSON..."></textarea>
        <div id="export-stats" class="export-stats"></div>
        <div class="copy-btn-wrapper">
          <button id="copy-json-btn" class="btn-secondary" disabled>üìã Copy to Clipboard</button>
          <button id="download-json-btn" class="btn-secondary" disabled>üíæ Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== STATE ====================
    let chatMessages = [];
    let conversationHistory = [];
    let currentDesignData = null;
    let isGenerating = false;
    let currentExportData = null; 

    // ==================== ELEMENTS ====================
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const statusEl = document.getElementById('status');
    
    // Tab elements
    const tabs = document.querySelectorAll('.tab');
    
    // Fetch API elements
    const fetchImportBtn = document.getElementById('fetch-import-btn');
    const apiUrlInput = document.getElementById('api-url');
    
    // Manual JSON elements
    const jsonImportBtn = document.getElementById('json-import-btn');
    const jsonInput = document.getElementById('json-input');
    const jsonStats = document.getElementById('json-stats');
    
    const exportSelectedBtn = document.getElementById('export-selected-btn');
    const exportAllBtn = document.getElementById('export-all-btn');
    const exportOutput = document.getElementById('export-output');
    const copyJsonBtn = document.getElementById('copy-json-btn');
    const downloadJsonBtn = document.getElementById('download-json-btn');
    const selectionInfo = document.getElementById('selection-info');
    const exportStats = document.getElementById('export-stats');
    
    // Cancel buttons
    const cancelBtn = document.getElementById('cancel-btn');
    const jsonCancelBtn = document.getElementById('json-cancel-btn');

    // ==================== TAB SWITCHING ====================
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        hideStatus();
      });
    });

    // ==================== AI CHAT FUNCTIONS ====================
    chatSendBtn.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message || isGenerating) return;

      addMessage('user', message);
      chatInput.value = '';
      chatInput.style.height = 'auto';
      isGenerating = true;
      chatSendBtn.disabled = true;

      conversationHistory.push({ role: 'user', content: message });
      addMessage('assistant', 'Creating your design...', true);

      parent.postMessage({
        pluginMessage: {
          type: 'ai-chat-message',
          message: message,
          history: conversationHistory
        }
      }, '*');
    }

    function addMessage(role, content, isLoading = false) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${role}`;
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';

      if (isLoading) {
        contentEl.innerHTML = `
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span>${content}</span>
          </div>
        `;
      } else {
        contentEl.innerHTML = `<div>${content}</div>`;
      }

      messageEl.appendChild(contentEl);
      chatMessagesEl.appendChild(messageEl);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      chatMessages.push({ role, content, timestamp: new Date() });
    }

    function removeLoadingMessages() {
      const loadingEls = chatMessagesEl.querySelectorAll('.loading-indicator');
      loadingEls.forEach(el => el.closest('.message').remove());
    }

    function addDesignPreview(designData, previewHtml = null) {
      const lastMessage = chatMessagesEl.lastElementChild;
      if (!lastMessage || !lastMessage.classList.contains('assistant')) return;

      const contentEl = lastMessage.querySelector('.message-content');
      if (!contentEl || contentEl.querySelector('.design-preview')) return;

      const previewEl = document.createElement('div');
      previewEl.className = 'design-preview';
      const uniqueId = 'import-btn-' + Date.now();
      const expandId = 'expand-btn-' + Date.now();

      const visualContent = previewHtml || '<div style="padding: 40px; color: #999;">Preview unavailable</div>';

      previewEl.innerHTML = `
        <div class="design-preview-header">
          <span class="design-preview-title">‚ú® Design Preview</span>
          <div class="preview-actions">
            <button class="expand-btn" id="${expandId}">üîç Expand</button>
            <button class="import-to-figma-btn" id="${uniqueId}" ${!designData ? 'disabled' : ''}>
              Import to Figma
            </button>
          </div>
        </div>
        <div class="design-preview-visual">
          ${visualContent}
        </div>
      `;

      contentEl.appendChild(previewEl);

      const expandBtn = document.getElementById(expandId);
      expandBtn.addEventListener('click', () => {
        const popup = window.open('', '_blank', 
          'width=1200,height=800,location=no,menubar=no,toolbar=no,scrollbars=yes');
        
        if (popup) {
          popup.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Design Preview - Full Screen</title>
              <style>
                body {
                  margin: 0;
                  padding: 20px;
                  background: #f5f5f5;
                  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                }
                .popup-container {
                  max-width: 100%;
                  background: white;
                  border-radius: 12px;
                  padding: 20px;
                  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                }
                .popup-preview {
                  max-height: 70vh;
                  overflow: auto;
                  padding: 15px;
                  background: #f9fafb;
                  border-radius: 8px;
                  border: 1px solid #e5e7eb;
                }
                .popup-actions {
                  margin-top: 20px;
                  display: flex;
                  gap: 12px;
                }
                .popup-btn {
                  padding: 10px 20px;
                  border-radius: 8px;
                  border: none;
                  cursor: pointer;
                  font-weight: 600;
                }
                .popup-import {
                  background: #6366f1;
                  color: white;
                }
                .popup-close {
                  background: #6b7280;
                  color: white;
                }
              </style>
            </head>
            <body>
              <div class="popup-container">
                <h2>Design Preview - Full Screen</h2>
                <div class="popup-preview">
                  ${previewHtml}
                </div>
                <div class="popup-actions">
                  <button class="popup-btn popup-import" onclick="importDesign()">
                    Import to Figma
                  </button>
                  <button class="popup-btn popup-close" onclick="window.close()">
                    Close
                  </button>
                </div>
              </div>
              <script>
                function importDesign() {
                  window.opener.postMessage({
                    pluginMessage: {
                      type: 'import-design-from-chat',
                      designData: ${JSON.stringify(designData)}
                    }
                  }, '*');
                  window.close();
                }
              <\/script>
            </body>
            </html>
          `);
          popup.document.close();
        }
      });

      const importButton = document.getElementById(uniqueId);
      if (importButton && designData) {
        importButton.addEventListener('click', () => {
          importButton.disabled = true;
          importButton.textContent = 'Importing...';
          parent.postMessage({
            pluginMessage: {
              type: 'import-design-from-chat',
              designData: designData
            }
          }, '*');
        });
      }
    }

    // ==================== FETCH API FUNCTIONS ====================
    fetchImportBtn.addEventListener('click', async () => {
      await handleApiFetch();
    });

    async function handleApiFetch() {
      const apiUrl = apiUrlInput.value.trim();
      if (!apiUrl) {
        showStatus('‚ùå Please enter an API URL', 'error');
        return;
      }

      try {
        showStatus('üì° Fetching...', 'info');
        fetchImportBtn.disabled = true;
        fetchImportBtn.textContent = 'Fetching...';
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
        
        const result = await response.json();
        let designData = result.data || result.design || result;
        
        parent.postMessage({ pluginMessage: { type: 'import-design', designData } }, '*');
        
        fetchImportBtn.disabled = false;
        fetchImportBtn.textContent = 'üì• Fetch & Import';
        
      } catch (error) {
        showStatus(`‚ùå ${error.message}`, 'error');
        fetchImportBtn.disabled = false;
        fetchImportBtn.textContent = 'üì• Fetch & Import';
      }
    }

    // ==================== MANUAL JSON FUNCTIONS ====================
    jsonImportBtn.addEventListener('click', async () => {
      await handleManualJson();
    });

    async function handleManualJson() {
      const jsonValue = jsonInput.value.trim();
      if (!jsonValue) {
        showStatus('‚ùå Please paste JSON', 'error');
        return;
      }

      try {
        const designData = JSON.parse(jsonValue);
        showStatus('üìã Importing...', 'info');
        jsonImportBtn.disabled = true;
        jsonImportBtn.textContent = 'Importing...';
        
        parent.postMessage({ pluginMessage: { type: 'import-design', designData } }, '*');
        
        jsonImportBtn.disabled = false;
        jsonImportBtn.textContent = 'üìã Import JSON';
        
      } catch (e) {
        showStatus(`‚ùå Invalid JSON: ${e.message}`, 'error');
        jsonImportBtn.disabled = false;
        jsonImportBtn.textContent = 'üìã Import JSON';
      }
    }

    jsonInput.addEventListener('input', () => {
      const value = jsonInput.value.trim();
      if (!value) {
        jsonInput.classList.remove('error', 'valid');
        jsonStats.textContent = '';
        return;
      }

      try {
        const parsed = JSON.parse(value);
        jsonInput.classList.remove('error');
        jsonInput.classList.add('valid');
        jsonStats.textContent = '‚úÖ Valid JSON';
        jsonStats.classList.remove('error');
      } catch (e) {
        jsonInput.classList.remove('valid');
        jsonInput.classList.add('error');
        jsonStats.classList.add('error');
        jsonStats.textContent = `‚ùå Invalid JSON: ${e.message}`;
      }
    });

    // ==================== EXPORT FUNCTIONS - Ÿáÿ∞Ÿä ÿßŸÑÿ¨ÿ≤ÿ¶Ÿäÿ© ÿßŸÑŸÖŸáŸÖÿ©! ====================
    exportSelectedBtn.addEventListener('click', () => {
      exportSelectedBtn.disabled = true;
      exportSelectedBtn.textContent = '‚è≥ Exporting...';
      parent.postMessage({ pluginMessage: { type: 'export-selected' } }, '*');
    });

    exportAllBtn.addEventListener('click', () => {
      exportAllBtn.disabled = true;
      exportAllBtn.textContent = '‚è≥ Exporting...';
      parent.postMessage({ pluginMessage: { type: 'export-all' } }, '*');
    });

    copyJsonBtn.addEventListener('click', async () => {
      if (!currentExportData) return;
      try {
        await navigator.clipboard.writeText(JSON.stringify(currentExportData, null, 2));
        showStatus('‚úÖ JSON copied!', 'success');
        copyJsonBtn.textContent = '‚úÖ Copied!';
        setTimeout(() => { copyJsonBtn.textContent = 'üìã Copy to Clipboard'; }, 2000);
      } catch (err) {
        showStatus('‚ùå Copy failed', 'error');
      }
    });

    downloadJsonBtn.addEventListener('click', () => {
      if (!currentExportData) return;
      const blob = new Blob([JSON.stringify(currentExportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `figma-design-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showStatus('‚úÖ Downloaded!', 'success');
    });

    function updateSelectionInfo(selection) {
      if (!selection || selection.count === 0) {
        selectionInfo.innerHTML = '<strong>No selection.</strong> Select layers to export specific elements, or export the entire page.';
        exportSelectedBtn.disabled = true;
      } else {
        const names = selection.names.slice(0, 3).join(', ');
        const more = selection.count > 3 ? ` and ${selection.count - 3} more` : '';
        selectionInfo.innerHTML = `<strong>${selection.count} layer${selection.count > 1 ? 's' : ''} selected:</strong> ${names}${more}`;
        exportSelectedBtn.disabled = false;
      }
    }

    function handleExportSuccess(msg) {
      currentExportData = msg.data; 
      exportOutput.value = JSON.stringify(msg.data, null, 2);
      copyJsonBtn.disabled = false;
      downloadJsonBtn.disabled = false;
      exportStats.textContent = `‚úÖ Exported ${msg.nodeCount} node(s)`;
      showStatus(`‚úÖ Exported ${msg.nodeCount} node(s)!`, 'success');
      resetExportButtons();
    }

    function resetExportButtons() {
      exportSelectedBtn.textContent = 'üì¶ Export Selected';
      exportAllBtn.textContent = 'üìÑ Export All (Page)';
      exportAllBtn.disabled = false;
      exportSelectedBtn.disabled = selectionInfo.textContent.includes('No selection');
    }

    // ==================== CANCEL FUNCTIONS ====================
    cancelBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });

    jsonCancelBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });

    // ==================== UTILITY FUNCTIONS ====================
    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    function hideStatus() {
      statusEl.className = 'status';
      statusEl.textContent = '';
    }

    // ==================== MESSAGE HANDLER ====================
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'ai-chat-response':
          isGenerating = false;
          chatSendBtn.disabled = false;
          removeLoadingMessages();
          
          addMessage('assistant', msg.message);
          conversationHistory.push({ role: 'assistant', content: msg.message });
          
          if (msg.designData || msg.previewHtml) {
            currentDesignData = msg.designData;
            addDesignPreview(msg.designData, msg.previewHtml);
          }
          break;

        case 'ai-chat-error':
          isGenerating = false;
          chatSendBtn.disabled = false;
          removeLoadingMessages();
          addMessage('assistant', `Error: ${msg.error}`);
          showStatus(`‚ùå ${msg.error}`, 'error');
          break;

        case 'import-success':
          showStatus('‚úÖ Design imported successfully!', 'success');
          setTimeout(hideStatus, 3000);
          break;

        case 'import-error':
          showStatus(`‚ùå Import failed: ${msg.error}`, 'error');
          break;

        case 'selection-changed':
          updateSelectionInfo(msg.selection);
          break;

        case 'export-success':
          handleExportSuccess(msg);
          break;

        case 'export-error':
          showStatus(`‚ùå Export failed: ${msg.error}`, 'error');
          resetExportButtons();
          break;
      }
    };

    // ==================== INITIALIZATION ====================
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    setTimeout(() => {
      parent.postMessage({ pluginMessage: { type: 'get-selection-info' } }, '*');
    }, 100);
  </script>
</body>
</html>